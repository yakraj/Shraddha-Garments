// Prisma Schema for Shraddha Garments Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          UserRole  @default(EMPLOYEE)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  employee      Employee?
  notifications Notification[]
  createdInvoices   Invoice[]  @relation("InvoiceCreatedBy")
  createdPOs        PurchaseOrder[] @relation("POCreatedBy")
}

enum UserRole {
  ADMIN
  MANAGER
  FLOOR_MANAGER
  EMPLOYEE
  ACCOUNTANT
}

// Employee Management
model Employee {
  id              String    @id @default(uuid())
  employeeId      String    @unique
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  department      String
  designation     String
  joiningDate     DateTime
  salary          Decimal   @db.Decimal(10, 2)
  address         String?
  emergencyContact String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  attendances     Attendance[]
  machineAssignments MachineAssignment[]
  measurements    Measurement[]
}

model Attendance {
  id          String          @id @default(uuid())
  employeeId  String
  employee    Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date        DateTime        @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  status      AttendanceStatus @default(PRESENT)
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([employeeId, date])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
}

// Machine Management
model Machine {
  id              String    @id @default(uuid())
  machineCode     String    @unique
  name            String
  type            String
  manufacturer    String?
  model           String?
  purchaseDate    DateTime?
  lastMaintenance DateTime?
  nextMaintenance DateTime?
  status          MachineStatus @default(IDLE)
  location        String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  assignments     MachineAssignment[]
  maintenanceLogs MaintenanceLog[]
}

enum MachineStatus {
  RUNNING
  IDLE
  MAINTENANCE_REQUIRED
  UNDER_MAINTENANCE
  OUT_OF_ORDER
}

model MachineAssignment {
  id          String    @id @default(uuid())
  machineId   String
  machine     Machine   @relation(fields: [machineId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  assignedAt  DateTime  @default(now())
  unassignedAt DateTime?
  isActive    Boolean   @default(true)
  
  @@unique([machineId, employeeId, isActive])
}

model MaintenanceLog {
  id          String    @id @default(uuid())
  machineId   String
  machine     Machine   @relation(fields: [machineId], references: [id], onDelete: Cascade)
  type        MaintenanceType
  description String
  cost        Decimal?  @db.Decimal(10, 2)
  performedAt DateTime  @default(now())
  performedBy String?
  nextDueDate DateTime?
  createdAt   DateTime  @default(now())
}

enum MaintenanceType {
  ROUTINE
  REPAIR
  EMERGENCY
  UPGRADE
}

// Materials Inventory
model Material {
  id              String    @id @default(uuid())
  materialCode    String    @unique
  name            String
  category        String
  unit            String
  quantity        Decimal   @db.Decimal(10, 2)
  minQuantity     Decimal   @db.Decimal(10, 2) @default(0)
  unitPrice       Decimal   @db.Decimal(10, 2)
  supplier        String?
  location        String?
  status          MaterialStatus @default(AVAILABLE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  transactions    MaterialTransaction[]
  purchaseOrderItems POItem[]
}

enum MaterialStatus {
  AVAILABLE
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

model MaterialTransaction {
  id          String    @id @default(uuid())
  materialId  String
  material    Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)
  type        TransactionType
  quantity    Decimal   @db.Decimal(10, 2)
  reference   String?
  notes       String?
  createdAt   DateTime  @default(now())
}

enum TransactionType {
  IN
  OUT
  ADJUSTMENT
  RETURN
}

// Customer Management
model Customer {
  id          String    @id @default(uuid())
  customerCode String   @unique
  name        String
  email       String?
  phone       String
  address     String?
  city        String?
  state       String?
  pincode     String?
  country     String?   @default("India")
  gstNumber   String?
  panNumber   String?
  paymentTerms Int?      // Payment terms in days
  notes       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  invoices    Invoice[]
  measurements Measurement[]
}

// Digital Measurement System
model Measurement {
  id              String    @id @default(uuid())
  measurementCode String    @unique
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  takenById       String
  takenBy         Employee  @relation(fields: [takenById], references: [id])
  garmentType     String
  
  // Upper Body Measurements (in cm)
  chest           Decimal?  @db.Decimal(6, 2)
  waist           Decimal?  @db.Decimal(6, 2)
  hips            Decimal?  @db.Decimal(6, 2)
  shoulder        Decimal?  @db.Decimal(6, 2)
  sleeveLength    Decimal?  @db.Decimal(6, 2)
  armHole         Decimal?  @db.Decimal(6, 2)
  bicep           Decimal?  @db.Decimal(6, 2)
  wrist           Decimal?  @db.Decimal(6, 2)
  neckRound       Decimal?  @db.Decimal(6, 2)
  frontLength     Decimal?  @db.Decimal(6, 2)
  backLength      Decimal?  @db.Decimal(6, 2)
  
  // Lower Body Measurements
  inseam          Decimal?  @db.Decimal(6, 2)
  outseam         Decimal?  @db.Decimal(6, 2)
  thigh           Decimal?  @db.Decimal(6, 2)
  knee            Decimal?  @db.Decimal(6, 2)
  calf            Decimal?  @db.Decimal(6, 2)
  ankle           Decimal?  @db.Decimal(6, 2)
  rise            Decimal?  @db.Decimal(6, 2)
  
  // Additional
  notes           String?
  customFields    Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Invoice System
model Invoice {
  id              String    @id @default(uuid())
  invoiceNumber   String    @unique
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id])
  createdById     String
  createdBy       User      @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  
  issueDate       DateTime  @default(now())
  dueDate         DateTime
  
  subtotal        Decimal   @db.Decimal(12, 2)
  taxRate         Decimal   @db.Decimal(5, 2) @default(0)
  taxAmount       Decimal   @db.Decimal(12, 2) @default(0)
  discountRate    Decimal   @db.Decimal(5, 2) @default(0)
  discountAmount  Decimal   @db.Decimal(12, 2) @default(0)
  roundOff        Decimal   @db.Decimal(10, 2) @default(0)
  totalAmount     Decimal   @db.Decimal(12, 2)
  paidAmount      Decimal   @db.Decimal(12, 2) @default(0)
  
  status          InvoiceStatus @default(DRAFT)
  notes           String?
  terms           String?

  // Transport & Delivery Details
  deliveryNote       String?
  deliveryNoteDate   DateTime?
  otherReference     String?
  otherReferences    String?
  buyersOrderNo      String?
  buyersOrderDate    DateTime?
  dispatchDocNo      String?
  dispatchedThrough  String?
  destination        String?
  billOfLading       String?
  motorVehicleNo     String?
  termsOfDelivery    String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  items           InvoiceItem[]
  payments        Payment[]
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

model InvoiceItem {
  id          String    @id @default(uuid())
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Decimal   @db.Decimal(10, 2)
  unitPrice   Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(12, 2)
  hsnCode     String?
  taxRate     Decimal   @db.Decimal(5, 2) @default(5.00)
}

model Payment {
  id          String    @id @default(uuid())
  invoiceId   String
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount      Decimal   @db.Decimal(12, 2)
  method      PaymentMethod
  reference   String?
  paidAt      DateTime  @default(now())
  notes       String?
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  UPI
  CHEQUE
  CARD
  OTHER
}

// Purchase Order System
model Supplier {
  id            String    @id @default(uuid())
  supplierCode  String    @unique
  name          String
  contactPerson String?
  email         String?
  phone         String
  address       String?
  city          String?
  state         String?
  country       String?   @default("India")
  gstNumber     String?
  panNumber     String?
  bankDetails   Json?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  purchaseOrders PurchaseOrder[]
}

model PurchaseOrder {
  id              String    @id @default(uuid())
  poNumber        String    @unique
  supplierId      String
  supplier        Supplier  @relation(fields: [supplierId], references: [id])
  createdById     String
  createdBy       User      @relation("POCreatedBy", fields: [createdById], references: [id])
  
  orderDate       DateTime  @default(now())
  expectedDate    DateTime?
  receivedDate    DateTime?
  
  subtotal        Decimal   @db.Decimal(12, 2)
  taxRate         Decimal   @db.Decimal(5, 2) @default(0)
  taxAmount       Decimal   @db.Decimal(12, 2) @default(0)
  shippingCost    Decimal   @db.Decimal(10, 2) @default(0)
  totalAmount     Decimal   @db.Decimal(12, 2)
  
  status          POStatus  @default(DRAFT)
  notes           String?
  terms           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  items           POItem[]
}

enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

model POItem {
  id              String    @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  materialId      String?
  material        Material? @relation(fields: [materialId], references: [id])
  description     String
  quantity        Decimal   @db.Decimal(10, 2)
  unitPrice       Decimal   @db.Decimal(10, 2)
  receivedQty     Decimal   @db.Decimal(10, 2) @default(0)
  amount          Decimal   @db.Decimal(12, 2)
}

// Notifications
model Notification {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  message     String
  type        NotificationType
  isRead      Boolean   @default(false)
  link        String?
  createdAt   DateTime  @default(now())
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  REMINDER
}

// Settings
model Setting {
  id          String    @id @default(uuid())
  key         String    @unique
  value       Json
  description String?
  updatedAt   DateTime  @updatedAt
}

// Master Data - HSN Codes
model HSN {
  id          String   @id @default(uuid())
  code        String   @unique
  description String?
  taxRate     Decimal  @db.Decimal(5, 2) @default(5.00)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Fabric Types
model FabricType {
  id          String   @id @default(uuid())
  code        String   @unique
  imageUrl    String
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
